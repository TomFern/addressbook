version: v1.0
name: Autoheal CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Debug and fix
    task:
      jobs:
        - name: Codex
          commands:
            - mkdir -p $HOME/.codex
            - cp agents/codex/config.toml $HOME/.codex
            - npm install -g @openai/codex
            - printenv OPENAI_API_KEY | codex login --with-api-key
            - '# run codex in full auto mode'
            - codex exec --dangerously-bypass-approvals-and-sandbox "$(envsubst < agents/prompt-template.txt)"
            - '# run tests just to validate codex did the right thing'
            - npm run lint
            - npm test
            - '# commit change'
            - git add -A
            - 'git commit -m "Autoheal CI: $(cat commit-message.txt)"'
            - git push origin "$AUTOHEAL_BRANCH"
            - cache store commit-message-$AUTOHEAL_BRANCH commit-message.txt
      secrets:
        - name: github
        - name: openai-api
        - name: semaphore-mcp
      prologue:
        commands:
          - 'export AUTOHEAL_BRANCH=autoheal-${SEMAPHORE_GIT_SHA}'
          - checkout
          - git config --global user.email "ci@semaphore.io"
          - git config --global user.name "Semaphore CI"
          - 'git remote set-url origin https://$GITHUB_TOKEN:x-oauth-basic@github.com/${SEMAPHORE_GIT_REPO_SLUG}.git'
          - git checkout -b "$AUTOHEAL_BRANCH"
          - nvm install
          - nvm use
          - cache restore
